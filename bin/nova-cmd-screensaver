#!/bin/bash
# Run the Nova screensaver using random effects from TTE

DOTFILES="${DOTFILES:-$HOME/.dotfiles}"
SCREENSAVER_TEXT="$DOTFILES/default/branding/screensaver.txt"

exit_screensaver() {
    pkill -x tte 2>/dev/null
    pkill -f org.nova.screensaver 2>/dev/null
    exit 0
}

# Exit on signals
trap exit_screensaver SIGINT SIGTERM SIGHUP SIGQUIT

# Set background color to black
printf '\033]11;rgb:00/00/00\007'

# Hide cursor
printf '\033[?25l'

tty=$(tty 2>/dev/null)

while true; do
    tte -i "$SCREENSAVER_TEXT" \
        --frame-rate 120 \
        --anchor-canvas c \
        --anchor-text c \
        --random-effect \
        --no-eol \
        --no-restore-cursor &

    # Wait for tte and check for keypress
    while pgrep -t "${tty#/dev/}" -x tte >/dev/null 2>&1; do
        if read -n1 -t 1; then
            exit_screensaver
        fi
    done
done

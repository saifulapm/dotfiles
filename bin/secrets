#!/bin/bash

# Secrets manager using age encryption
# Usage:
#   secrets edit     - Decrypt, edit, re-encrypt secrets
#   secrets get KEY  - Get a single secret value
#   secrets load     - Export all secrets as env vars (use: eval "$(secrets load)")

DOTFILES="${DOTFILES:-$HOME/.dotfiles}"
SECRETS_FILE="$DOTFILES/secrets.age"
SECRETS_EXAMPLE="$DOTFILES/secrets.example"

if ! command -v age &>/dev/null; then
    echo "Installing age..."
    sudo dnf install -y age || { echo "Failed to install age" >&2; exit 1; }
fi

case "$1" in
    init)
        if [[ -f "$SECRETS_FILE" ]]; then
            echo "secrets.age already exists" >&2
            exit 1
        fi
        if [[ -f "$SECRETS_EXAMPLE" ]]; then
            cp "$SECRETS_EXAMPLE" /tmp/secrets.txt
        else
            cat > /tmp/secrets.txt << 'EOF'
# Secrets file - one per line: KEY=value
# Example:
# INTELEPHENSE_KEY=your-license-key
# GITHUB_TOKEN=ghp_xxxx
EOF
        fi
        ${EDITOR:-nano} /tmp/secrets.txt
        age -p -o "$SECRETS_FILE" /tmp/secrets.txt
        rm -f /tmp/secrets.txt
        echo "Created $SECRETS_FILE"
        ;;
    edit)
        if [[ ! -f "$SECRETS_FILE" ]]; then
            echo "No secrets.age found. Run: secrets init" >&2
            exit 1
        fi
        age -d "$SECRETS_FILE" > /tmp/secrets.txt
        ${EDITOR:-nano} /tmp/secrets.txt
        age -p -o "$SECRETS_FILE" /tmp/secrets.txt
        rm -f /tmp/secrets.txt
        echo "Secrets updated"
        ;;
    get)
        if [[ -z "$2" ]]; then
            echo "Usage: secrets get KEY" >&2
            exit 1
        fi
        if [[ ! -f "$SECRETS_FILE" ]]; then
            exit 1
        fi
        age -d "$SECRETS_FILE" 2>/dev/null | grep "^$2=" | cut -d'=' -f2-
        ;;
    load)
        if [[ ! -f "$SECRETS_FILE" ]]; then
            exit 0
        fi
        age -d "$SECRETS_FILE" 2>/dev/null | grep -v '^#' | grep '=' | while read -r line; do
            echo "export $line"
        done
        ;;
    *)
        echo "Usage: secrets {init|edit|get KEY|load}" >&2
        echo ""
        echo "Commands:"
        echo "  init     Create new encrypted secrets file"
        echo "  edit     Edit secrets (decrypt, edit, re-encrypt)"
        echo "  get KEY  Get a single secret value"
        echo "  load     Export secrets as env vars: eval \"\$(secrets load)\""
        exit 1
        ;;
esac

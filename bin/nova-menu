#!/bin/bash
# Nova Menu - hierarchical menu system using fuzzel

DOTFILES="${DOTFILES:-$HOME/.dotfiles}"

menu() {
    local prompt="$1"
    shift
    printf '%s\n' "$@" | fuzzel --dmenu -p "$prompt" -w 35 -l 10
}

show_style_menu() {
    local choice
    choice=$(menu "Style" "  Theme" "  Background")
    case "$choice" in
        *Theme*) show_theme_menu ;;
        *Background*) show_background_menu ;;
    esac
}

show_theme_menu() {
    local themes theme

    # Get list of available themes
    themes=$(ls -1 "$DOTFILES/themes" 2>/dev/null)
    if [[ -z "$themes" ]]; then
        notify-send "No themes found" "Check $DOTFILES/themes directory"
        return
    fi

    # Show theme picker
    theme=$(printf '%s\n' $themes | fuzzel --dmenu -p "Theme" -w 40 -l 15)

    if [[ -n "$theme" ]]; then
        theme set "$theme"
        notify-send "Theme Applied" "$theme"
    fi
}

show_background_menu() {
    local choice
    choice=$(menu "Background" "  Next" "  Random" "  From Theme")
    case "$choice" in
        *Next*) nova-bg-next ;;
        *Random*) nova-bg-next --random 2>/dev/null || nova-bg-next ;;
        *From\ Theme*) nova-bg-next --theme 2>/dev/null || nova-bg-next ;;
    esac
}

show_setup_menu() {
    local choice
    choice=$(menu "Setup" "  Audio" "  Wifi" "  Bluetooth")
    case "$choice" in
        *Audio*) nova-launch-audio ;;
        *Wifi*) nova-launch-wifi ;;
        *Bluetooth*) nova-launch-bluetooth ;;
    esac
}

show_toggle_menu() {
    local choice
    choice=$(menu "Toggle" "  Screensaver")
    case "$choice" in
        *Screensaver*) nova-toggle-screensaver ;;
    esac
}

show_system_menu() {
    local choice
    choice=$(menu "System" "  Lock" "  Screensaver" "  Restart" "  Shutdown")
    case "$choice" in
        *Lock*) swaylock ;;
        *Screensaver*) nova-launch-screensaver ;;
        *Restart*) systemctl reboot ;;
        *Shutdown*) systemctl poweroff ;;
    esac
}

show_main_menu() {
    local choice
    choice=$(menu "Nova" "  Apps" "  Keybindings" "  Style" "  Toggle" "  Setup" "  System")
    case "$choice" in
        *Apps*) fuzzel ;;
        *Keybindings*) nova-menu-keybindings ;;
        *Style*) show_style_menu ;;
        *Toggle*) show_toggle_menu ;;
        *Setup*) show_setup_menu ;;
        *System*) show_system_menu ;;
    esac
}

# Allow direct submenu access
case "${1,,}" in
    style) show_style_menu ;;
    theme) show_theme_menu ;;
    background) show_background_menu ;;
    toggle) show_toggle_menu ;;
    setup) show_setup_menu ;;
    system) show_system_menu ;;
    keybindings) nova-menu-keybindings ;;
    *) show_main_menu ;;
esac

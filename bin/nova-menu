#!/bin/bash
# Nova Menu - hierarchical menu system using fuzzel

DOTFILES="${DOTFILES:-$HOME/.dotfiles}"

menu() {
    local prompt="$1"
    shift
    printf '%s\n' "$@" | fuzzel --dmenu -p "$prompt: " -w 35 -l 12
}

open_in_editor() {
    notify-send "Editing config" "$1"
    nova-launch-editor "$1"
}

present_terminal() {
    nova-launch-floating-terminal-with-presentation "$@"
}

# ─────────────────────────────────────────────────────────────
# Capture Submenu
# ─────────────────────────────────────────────────────────────
show_screenshot_menu() {
    local choice
    choice=$(menu "Screenshot" \
        "󰹑  Interactive" \
        "󰍹  Full Screen" \
        "󱂬  Window" \
        "󰩭  Region (clipboard)" \
        "󰏫  Region (edit)")
    case "$choice" in
        *Interactive*) nova-cmd-screenshot interactive ;;
        *Full*) nova-cmd-screenshot screen ;;
        *Window*) nova-cmd-screenshot window ;;
        *clipboard*) nova-cmd-screenshot region ;;
        *edit*) nova-cmd-screenshot region-edit ;;
        *) show_capture_menu ;;
    esac
}

show_screenrecord_menu() {
    if pgrep -x wf-recorder > /dev/null; then
        nova-cmd-screenrecord
        return
    fi

    local choice
    choice=$(menu "Screen Record" \
        "󰕾  Desktop Audio" \
        "󰍬  Microphone Only" \
        "󰝟  No Audio")
    case "$choice" in
        *Desktop*) nova-cmd-screenrecord --desktop ;;
        *Microphone*) nova-cmd-screenrecord --mic ;;
        *No*) nova-cmd-screenrecord --no-audio ;;
        *) show_capture_menu ;;
    esac
}

show_capture_menu() {
    local choice
    choice=$(menu "Capture" \
        "󰹑  Screenshot" \
        "󰻃  Screen Record" \
        "󰃉  Color Picker")
    case "$choice" in
        *Screenshot*) show_screenshot_menu ;;
        *Record*) show_screenrecord_menu ;;
        *Color*) nova-color-picker ;;
        *) show_trigger_menu ;;
    esac
}

# ─────────────────────────────────────────────────────────────
# Share Submenu
# ─────────────────────────────────────────────────────────────
show_share_menu() {
    local choice
    choice=$(menu "Share" \
        "󰅍  Clipboard" \
        "󰈔  File" \
        "󰉋  Folder")
    case "$choice" in
        *Clipboard*) nova-cmd-share clipboard ;;
        *File*) present_terminal nova-cmd-share file ;;
        *Folder*) present_terminal nova-cmd-share folder ;;
        *) show_trigger_menu ;;
    esac
}

# ─────────────────────────────────────────────────────────────
# Toggle Submenu
# ─────────────────────────────────────────────────────────────
show_toggle_menu() {
    local choice
    choice=$(menu "Toggle" \
        "󱄄  Screensaver" \
        "󰔎  Night Light" \
        "󱫖  Idle Lock" \
        "󰍜  Top Bar" \
        "󰒲  Suspend")
    case "$choice" in
        *Screensaver*) nova-toggle-screensaver ;;
        *Night*) nova-toggle-nightlight ;;
        *Idle*) nova-toggle-idle ;;
        *Bar*) nova-toggle-waybar ;;
        *Suspend*) present_terminal nova-toggle-suspend ;;
        *) show_trigger_menu ;;
    esac
}

# ─────────────────────────────────────────────────────────────
# Trigger Menu
# ─────────────────────────────────────────────────────────────
show_trigger_menu() {
    local choice
    choice=$(menu "Trigger" \
        "󰹑  Capture" \
        "󰁦  Share" \
        "󰔎  Toggle")
    case "$choice" in
        *Capture*) show_capture_menu ;;
        *Share*) show_share_menu ;;
        *Toggle*) show_toggle_menu ;;
        *) show_main_menu ;;
    esac
}

# ─────────────────────────────────────────────────────────────
# Learn Menu
# ─────────────────────────────────────────────────────────────
show_learn_menu() {
    local choice
    choice=$(menu "Learn" \
        "󰌌  Keybindings" \
        "󰖟  Niri Docs" \
        "󰣇  Fedora Docs" \
        "󰅩  Neovim" \
        "󱆃  Bash")
    case "$choice" in
        *Keybindings*) nova-menu-keybindings ;;
        *Niri*) xdg-open "https://github.com/YaLTeR/niri/wiki" ;;
        *Fedora*) xdg-open "https://docs.fedoraproject.org/" ;;
        *Neovim*) xdg-open "https://www.lazyvim.org/keymaps" ;;
        *Bash*) xdg-open "https://devhints.io/bash" ;;
        *) show_main_menu ;;
    esac
}

# ─────────────────────────────────────────────────────────────
# Style Menu
# ─────────────────────────────────────────────────────────────
show_theme_menu() {
    local themes theme

    themes=$(ls -1 "$DOTFILES/themes" 2>/dev/null)
    if [[ -z "$themes" ]]; then
        notify-send "No themes found" "Check $DOTFILES/themes directory"
        return
    fi

    theme=$(printf '%s\n' $themes | fuzzel --dmenu -p "Theme" -w 40 -l 15)

    if [[ -n "$theme" ]]; then
        theme set "$theme"
        notify-send "Theme Applied" "$theme"
    fi
}

show_background_menu() {
    local choice
    choice=$(menu "Background" "󰒭  Next" "󰒝  Random" "󰸌  From Theme")
    case "$choice" in
        *Next*) nova-bg-next ;;
        *Random*) nova-bg-next --random 2>/dev/null || nova-bg-next ;;
        *From\ Theme*) nova-bg-next --theme 2>/dev/null || nova-bg-next ;;
        *) show_style_menu ;;
    esac
}

show_style_menu() {
    local choice
    choice=$(menu "Style" \
        "󰸌  Theme" \
        "󰛖  Font" \
        "󰸉  Background")
    case "$choice" in
        *Theme*) show_theme_menu ;;
        *Font*) show_font_menu ;;
        *Background*) show_background_menu ;;
        *) show_main_menu ;;
    esac
}

show_font_menu() {
    local current fonts selected
    current=$(nova-font-current)
    fonts=$(nova-font-list)

    selected=$(echo "$fonts" | fuzzel --dmenu -p "Font: " -w 50 -l 15)

    if [[ -n "$selected" && "$selected" != "$current" ]]; then
        nova-font-set "$selected"
    fi
}

# ─────────────────────────────────────────────────────────────
# Setup Menu
# ─────────────────────────────────────────────────────────────
show_config_menu() {
    local choice
    choice=$(menu "Config" \
        "󱂀  Niri" \
        "󰌾  Swaylock" \
        "󰂚  Mako" \
        "󰍜  Waybar" \
        "󰆍  Foot" \
        "󰊠  Ghostty" \
        "󰆍  Alacritty")
    case "$choice" in
        *Niri*) open_in_editor ~/.config/niri/config.kdl ;;
        *Swaylock*) open_in_editor ~/.config/swaylock/config ;;
        *Mako*) open_in_editor ~/.config/mako/config ;;
        *Waybar*) open_in_editor ~/.config/waybar/config.jsonc ;;
        *Foot*) open_in_editor ~/.config/foot/foot.ini ;;
        *Ghostty*) open_in_editor ~/.config/ghostty/config ;;
        *Alacritty*) open_in_editor ~/.config/alacritty/alacritty.toml ;;
        *) show_setup_menu ;;
    esac
}

show_power_menu() {
    local profiles current selected
    profiles=$(nova-powerprofiles-list)
    current=$(powerprofilesctl get 2>/dev/null)

    selected=$(echo "$profiles" | fuzzel --dmenu -p "Power Profile: " -w 40 -l 5)

    if [[ -n "$selected" ]]; then
        powerprofilesctl set "$selected"
        notify-send "Power Profile" "Set to $selected"
    fi
}

show_restart_menu() {
    local choice
    choice=$(menu "Restart" \
        "󰂚  Mako" \
        "󰍜  Waybar" \
        "󰝚  SwayOSD" \
        "󰕾  Pipewire" \
        "󰂯  Bluetooth" \
        "󰖩  WiFi")
    case "$choice" in
        *Mako*) nova-restart-mako && notify-send "Mako" "Reloaded" ;;
        *Waybar*) nova-restart-waybar && notify-send "Waybar" "Restarted" ;;
        *SwayOSD*) nova-restart-swayosd && notify-send "SwayOSD" "Restarted" ;;
        *Pipewire*) present_terminal nova-restart-pipewire ;;
        *Bluetooth*) present_terminal nova-restart-bluetooth ;;
        *WiFi*) present_terminal nova-restart-wifi ;;
        *) show_setup_menu ;;
    esac
}

show_setup_menu() {
    local choice
    choice=$(menu "Setup" \
        "󰕾  Audio" \
        "󰖩  Wifi" \
        "󰂯  Bluetooth" \
        "󱐋  Power Profile" \
        "󰍹  Monitors" \
        "󰌌  Keybindings" \
        "󱔫  DNS" \
        "󰑓  Restart" \
        "󰒓  Config")
    case "$choice" in
        *Audio*) nova-launch-audio ;;
        *Wifi*) nova-launch-wifi ;;
        *Bluetooth*) nova-launch-bluetooth ;;
        *Power*) show_power_menu ;;
        *Monitors*) open_in_editor ~/.config/niri/outputs.kdl ;;
        *Keybindings*) open_in_editor ~/.config/niri/binds.kdl ;;
        *DNS*) present_terminal nova-setup-dns ;;
        *Restart*) show_restart_menu ;;
        *Config*) show_config_menu ;;
        *) show_main_menu ;;
    esac
}

# ─────────────────────────────────────────────────────────────
# System Menu
# ─────────────────────────────────────────────────────────────
show_system_menu() {
    local choice
    choice=$(menu "System" \
        "󰌾  Lock" \
        "󱄄  Screensaver" \
        "󰒲  Suspend" \
        "󰜉  Restart" \
        "󰐥  Shutdown")
    case "$choice" in
        *Lock*) nova-lock-screen ;;
        *Screensaver*) nova-launch-screensaver ;;
        *Suspend*) systemctl suspend ;;
        *Restart*) nova-cmd-reboot ;;
        *Shutdown*) nova-cmd-shutdown ;;
        *) show_main_menu ;;
    esac
}

# ─────────────────────────────────────────────────────────────
# Install Menu
# ─────────────────────────────────────────────────────────────
show_install_menu() {
    local choice
    choice=$(menu "Install" \
        "󰣇  Package (DNF)" \
        "󰖟  Web App" \
        "󰵮  Development")
    case "$choice" in
        *Package*) present_terminal nova-pkg-install ;;
        *Web*) present_terminal nova-webapp-install ;;
        *Development*) show_install_development_menu ;;
        *) show_main_menu ;;
    esac
}

show_install_development_menu() {
    local choice
    choice=$(menu "Install" \
        "󰫏  Ruby on Rails" \
        "  JavaScript" \
        "  Go" \
        "  PHP" \
        "  Python" \
        "  Elixir" \
        "  Zig" \
        "  Rust" \
        "  Java" \
        "  .NET" \
        "  OCaml" \
        "  Clojure")
    case "$choice" in
        *Rails*) present_terminal nova-dev-install ruby ;;
        *JavaScript*) show_install_javascript_menu ;;
        *Go*) present_terminal nova-dev-install go ;;
        *PHP*) show_install_php_menu ;;
        *Python*) present_terminal nova-dev-install python ;;
        *Elixir*) show_install_elixir_menu ;;
        *Zig*) present_terminal nova-dev-install zig ;;
        *Rust*) present_terminal nova-dev-install rust ;;
        *Java*) present_terminal nova-dev-install java ;;
        *NET*) present_terminal nova-dev-install dotnet ;;
        *OCaml*) present_terminal nova-dev-install ocaml ;;
        *Clojure*) present_terminal nova-dev-install clojure ;;
        *) show_install_menu ;;
    esac
}

show_install_javascript_menu() {
    local choice
    choice=$(menu "Install" \
        "  Node.js" \
        "  Bun" \
        "  Deno")
    case "$choice" in
        *Node*) present_terminal nova-dev-install node ;;
        *Bun*) present_terminal nova-dev-install bun ;;
        *Deno*) present_terminal nova-dev-install deno ;;
        *) show_install_development_menu ;;
    esac
}

show_install_php_menu() {
    local choice
    choice=$(menu "Install" \
        "  PHP" \
        "  Laravel")
    case "$choice" in
        *PHP*) present_terminal nova-dev-install php ;;
        *Laravel*) present_terminal nova-dev-install laravel ;;
        *) show_install_development_menu ;;
    esac
}

show_install_elixir_menu() {
    local choice
    choice=$(menu "Install" \
        "  Elixir" \
        "  Phoenix")
    case "$choice" in
        *Elixir*) present_terminal nova-dev-install elixir ;;
        *Phoenix*) present_terminal nova-dev-install phoenix ;;
        *) show_install_development_menu ;;
    esac
}

# ─────────────────────────────────────────────────────────────
# Remove Menu
# ─────────────────────────────────────────────────────────────
show_remove_menu() {
    local choice
    choice=$(menu "Remove" \
        "󰣇  Package (DNF)" \
        "󰖟  Web App" \
        "󰵮  Development")
    case "$choice" in
        *Package*) present_terminal nova-pkg-remove ;;
        *Web*) present_terminal nova-webapp-remove ;;
        *Development*) show_remove_development_menu ;;
        *) show_main_menu ;;
    esac
}

show_remove_development_menu() {
    local choice
    choice=$(menu "Remove" \
        "󰫏  Ruby on Rails" \
        "  JavaScript" \
        "  Go" \
        "  PHP" \
        "  Python" \
        "  Elixir" \
        "  Zig" \
        "  Rust" \
        "  Java" \
        "  .NET" \
        "  OCaml" \
        "  Clojure")
    case "$choice" in
        *Rails*) present_terminal nova-dev-remove ruby ;;
        *JavaScript*) show_remove_javascript_menu ;;
        *Go*) present_terminal nova-dev-remove go ;;
        *PHP*) show_remove_php_menu ;;
        *Python*) present_terminal nova-dev-remove python ;;
        *Elixir*) show_remove_elixir_menu ;;
        *Zig*) present_terminal nova-dev-remove zig ;;
        *Rust*) present_terminal nova-dev-remove rust ;;
        *Java*) present_terminal nova-dev-remove java ;;
        *NET*) present_terminal nova-dev-remove dotnet ;;
        *OCaml*) present_terminal nova-dev-remove ocaml ;;
        *Clojure*) present_terminal nova-dev-remove clojure ;;
        *) show_remove_menu ;;
    esac
}

show_remove_javascript_menu() {
    local choice
    choice=$(menu "Remove" \
        "  Node.js" \
        "  Bun" \
        "  Deno")
    case "$choice" in
        *Node*) present_terminal nova-dev-remove node ;;
        *Bun*) present_terminal nova-dev-remove bun ;;
        *Deno*) present_terminal nova-dev-remove deno ;;
        *) show_remove_development_menu ;;
    esac
}

show_remove_php_menu() {
    local choice
    choice=$(menu "Remove" \
        "  PHP" \
        "  Laravel")
    case "$choice" in
        *PHP*) present_terminal nova-dev-remove php ;;
        *Laravel*) present_terminal nova-dev-remove laravel ;;
        *) show_remove_development_menu ;;
    esac
}

show_remove_elixir_menu() {
    local choice
    choice=$(menu "Remove" \
        "  Elixir" \
        "  Phoenix")
    case "$choice" in
        *Elixir*) present_terminal nova-dev-remove elixir ;;
        *Phoenix*) present_terminal nova-dev-remove phoenix ;;
        *) show_remove_development_menu ;;
    esac
}

# ─────────────────────────────────────────────────────────────
# Main Menu
# ─────────────────────────────────────────────────────────────
show_main_menu() {
    local choice
    choice=$(menu "Nova" \
        "󰀻  Apps" \
        "󰌌  Keybindings" \
        "󰧑  Learn" \
        "󱓞  Trigger" \
        "󰸌  Style" \
        "󰒓  Setup" \
        "󰏗  Install" \
        "󰆴  Remove" \
        "󰐥  System")
    case "$choice" in
        *Apps*) fuzzel ;;
        *Keybindings*) nova-menu-keybindings ;;
        *Learn*) show_learn_menu ;;
        *Trigger*) show_trigger_menu ;;
        *Style*) show_style_menu ;;
        *Setup*) show_setup_menu ;;
        *Install*) show_install_menu ;;
        *Remove*) show_remove_menu ;;
        *System*) show_system_menu ;;
    esac
}

# ─────────────────────────────────────────────────────────────
# Direct submenu access
# ─────────────────────────────────────────────────────────────
case "${1,,}" in
    apps) fuzzel ;;
    keybindings) nova-menu-keybindings ;;
    learn) show_learn_menu ;;
    trigger) show_trigger_menu ;;
    capture) show_capture_menu ;;
    screenshot) show_screenshot_menu ;;
    screenrecord) show_screenrecord_menu ;;
    share) show_share_menu ;;
    toggle) show_toggle_menu ;;
    style) show_style_menu ;;
    theme) show_theme_menu ;;
    background) show_background_menu ;;
    setup) show_setup_menu ;;
    config) show_config_menu ;;
    power) show_power_menu ;;
    restart) show_restart_menu ;;
    install) show_install_menu ;;
    install-development) show_install_development_menu ;;
    remove) show_remove_menu ;;
    remove-development) show_remove_development_menu ;;
    system) show_system_menu ;;
    *) show_main_menu ;;
esac

#!/bin/bash

# Nova Background Switcher
# Cycles through background images for the current theme

THEME_NAME=$(cat "$HOME/.config/nova/current/theme.name" 2>/dev/null)
THEME_BACKGROUNDS_PATH="$HOME/.config/nova/current/theme/backgrounds/"
USER_BACKGROUNDS_PATH="$HOME/.config/nova/backgrounds/$THEME_NAME/"
CURRENT_BACKGROUND_LINK="$HOME/.config/nova/current/background"

# Find all background images
mapfile -d '' -t BACKGROUNDS < <(find -L "$USER_BACKGROUNDS_PATH" "$THEME_BACKGROUNDS_PATH" -maxdepth 1 -type f \( -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.webp" \) -print0 2>/dev/null | sort -z)
TOTAL=${#BACKGROUNDS[@]}

if [[ $TOTAL -eq 0 ]]; then
    # No backgrounds found, set solid color
    if command -v notify-send &>/dev/null; then
        notify-send "Nova" "No background found for theme" -t 2000
    fi
    pkill -x swaybg 2>/dev/null
    swaybg --color '#1e1e2e' &>/dev/null &
    disown
    exit 0
fi

# Get current background from symlink
if [[ -L "$CURRENT_BACKGROUND_LINK" ]]; then
    CURRENT_BACKGROUND=$(readlink "$CURRENT_BACKGROUND_LINK")
else
    CURRENT_BACKGROUND=""
fi

# Find current background index
INDEX=-1
for i in "${!BACKGROUNDS[@]}"; do
    if [[ "${BACKGROUNDS[$i]}" == "$CURRENT_BACKGROUND" ]]; then
        INDEX=$i
        break
    fi
done

# Get next background (wrap around)
if [[ $INDEX -eq -1 ]]; then
    # Use the first background when no match was found
    NEW_BACKGROUND="${BACKGROUNDS[0]}"
else
    NEXT_INDEX=$(((INDEX + 1) % TOTAL))
    NEW_BACKGROUND="${BACKGROUNDS[$NEXT_INDEX]}"
fi

# Set new background symlink
ln -nsf "$NEW_BACKGROUND" "$CURRENT_BACKGROUND_LINK"

# Relaunch swaybg
pkill -x swaybg 2>/dev/null
sleep 0.1
swaybg -i "$CURRENT_BACKGROUND_LINK" -m fill &>/dev/null &
disown

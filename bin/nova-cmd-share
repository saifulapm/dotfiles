#!/bin/bash
# Share clipboard, file, or folder using LocalSend (matches omarchy approach)
# Note: Using flatpak version since native localsend not available

if (($# == 0)); then
    echo "Usage: nova-cmd-share [clipboard|file|folder]"
    exit 1
fi

MODE="$1"
shift

if [[ $MODE == "clipboard" ]]; then
    TEMP_FILE=$(mktemp --suffix=.txt)
    wl-paste > "$TEMP_FILE"
    if [[ ! -s "$TEMP_FILE" ]]; then
        notify-send "Share" "Clipboard is empty"
        rm -f "$TEMP_FILE"
        exit 1
    fi
    FILES="$TEMP_FILE"
else
    if (($# > 0)); then
        FILES="$*"
    else
        if [[ $MODE == "folder" ]]; then
            # Pick a single folder from home directory
            FILES=$(find "$HOME" -type d 2>/dev/null | fzf)
        else
            # Pick one or more files from home directory
            FILES=$(find "$HOME" -type f 2>/dev/null | fzf --multi)
        fi
        [[ -z "$FILES" ]] && exit 0
    fi
fi

# Run LocalSend (flatpak version - doesn't support --headless like native)
if [[ $MODE != "clipboard" ]] && echo "$FILES" | grep -q $'\n'; then
    # Multiple files selected - convert newlines to array
    readarray -t FILE_ARRAY <<< "$FILES"
    flatpak run org.localsend.localsend_app "${FILE_ARRAY[@]}" &
else
    # Single file or clipboard mode
    flatpak run org.localsend.localsend_app "$FILES" &
fi

notify-send "Share" "Opening LocalSend..."
exit 0

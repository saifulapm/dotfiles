#!/bin/bash
# Share clipboard, file, or folder using LocalSend
# Opens LocalSend GUI with files ready to send (detached via systemd-run)

if (($# == 0)); then
    echo "Usage: nova-cmd-share [clipboard|file|folder]"
    exit 1
fi

MODE="$1"
shift

if [[ $MODE == "clipboard" ]]; then
    TEMP_FILE=$(mktemp --suffix=.txt)
    wl-paste > "$TEMP_FILE"
    if [[ ! -s "$TEMP_FILE" ]]; then
        notify-send "Share" "Clipboard is empty"
        rm -f "$TEMP_FILE"
        exit 1
    fi
    FILES="$TEMP_FILE"
else
    if (($# > 0)); then
        FILES="$*"
    else
        if [[ $MODE == "folder" ]]; then
            FILES=$(find "$HOME" -type d 2>/dev/null | fzf)
        else
            FILES=$(find "$HOME" -type f 2>/dev/null | fzf --multi)
        fi
        [[ -z "$FILES" ]] && exit 0
    fi
fi

# Launch LocalSend detached via systemd-run (like omarchy)
if [[ $MODE != "clipboard" ]] && echo "$FILES" | grep -q $'\n'; then
    readarray -t FILE_ARRAY <<< "$FILES"
    systemd-run --user --quiet --collect localsend "${FILE_ARRAY[@]}"
else
    systemd-run --user --quiet --collect localsend "$FILES"
fi

exit 0

#!/bin/bash
# Cycle through background images for current theme

DOTFILES="${DOTFILES:-$HOME/.dotfiles}"
THEME_FILE="$HOME/.config/nova/current/theme.name"
THEME_NAME=$(cat "$THEME_FILE" 2>/dev/null || echo "catppuccin")

THEME_BACKGROUNDS_PATH="$DOTFILES/themes/$THEME_NAME/backgrounds/"
USER_BACKGROUNDS_PATH="$HOME/.config/nova/backgrounds/$THEME_NAME/"
CURRENT_BACKGROUND_LINK="$HOME/.config/nova/current/background"

# Find all backgrounds (theme + user)
mapfile -d '' -t BACKGROUNDS < <(find -L "$USER_BACKGROUNDS_PATH" "$THEME_BACKGROUNDS_PATH" -maxdepth 1 -type f \( -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.webp" \) -print0 2>/dev/null | sort -z)
TOTAL=${#BACKGROUNDS[@]}

reload_swaybg() {
    if systemctl --user is-active swaybg.service &>/dev/null; then
        systemctl --user restart swaybg.service
    else
        pkill -x swaybg 2>/dev/null
        swaybg -i "$CURRENT_BACKGROUND_LINK" -m fill &>/dev/null &
        disown
    fi
}

if [[ $TOTAL -eq 0 ]]; then
    notify-send "No backgrounds found for theme: $THEME_NAME" -t 2000
else
    # Get current background from symlink
    if [[ -L "$CURRENT_BACKGROUND_LINK" ]]; then
        CURRENT_BACKGROUND=$(readlink "$CURRENT_BACKGROUND_LINK")
    else
        CURRENT_BACKGROUND=""
    fi

    # Find current background index
    INDEX=-1
    for i in "${!BACKGROUNDS[@]}"; do
        if [[ "${BACKGROUNDS[$i]}" == "$CURRENT_BACKGROUND" ]]; then
            INDEX=$i
            break
        fi
    done

    # Get next background (wrap around)
    if [[ $INDEX -eq -1 ]]; then
        NEW_BACKGROUND="${BACKGROUNDS[0]}"
    else
        NEXT_INDEX=$(((INDEX + 1) % TOTAL))
        NEW_BACKGROUND="${BACKGROUNDS[$NEXT_INDEX]}"
    fi

    # Set new background symlink
    mkdir -p "$(dirname "$CURRENT_BACKGROUND_LINK")"
    ln -nsf "$NEW_BACKGROUND" "$CURRENT_BACKGROUND_LINK"

    # Reload swaybg
    reload_swaybg
fi

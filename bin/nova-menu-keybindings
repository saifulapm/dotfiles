#!/bin/bash
# Display niri keybindings using walker dmenu

BINDS_FILE="${DOTFILES:-$HOME/.dotfiles}/config/niri/binds.kdl"

parse_bindings() {
    grep -E '^\s*(Mod|Super|Ctrl|Alt|Shift)' "$BINDS_FILE" | while IFS= read -r line; do
        # Extract key combo and title/action
        if [[ "$line" =~ ([A-Za-z+_]+)[[:space:]]+hotkey-overlay-title=\"([^\"]+)\" ]]; then
            key="${BASH_REMATCH[1]}"
            title="${BASH_REMATCH[2]}"
            printf "%-25s  %s\n" "$key" "$title"
        elif [[ "$line" =~ ([A-Za-z+_0-9]+)[[:space:]]+\{ ]]; then
            key="${BASH_REMATCH[1]}"
            # Extract action from inside braces
            action=$(echo "$line" | sed -n 's/.*{\s*\([^;]*\).*/\1/p' | head -1)
            [[ -n "$action" ]] && printf "%-25s  %s\n" "$key" "$action"
        fi
    done | sort -u
}

if [[ "$1" == "--print" || "$1" == "-p" ]]; then
    parse_bindings
else
    parse_bindings | walker --dmenu -p 'Keybindings' --width 700 --maxheight 500
fi

#!/bin/bash
# Display niri keybindings using fuzzel dmenu

BINDS_FILE="${DOTFILES:-$HOME/.dotfiles}/config/niri/binds.kdl"

parse_bindings() {
    while IFS= read -r line; do
        # Skip comments and empty lines
        [[ "$line" =~ ^[[:space:]]*//.* ]] && continue
        [[ -z "${line// }" ]] && continue

        # Match lines with hotkey-overlay-title (preferred)
        if [[ "$line" =~ ^[[:space:]]*(Mod|Super|Ctrl|Alt|Shift|XF86|Print)[A-Za-z0-9+_]*[[:space:]]+.*hotkey-overlay-title=\"([^\"]+)\" ]]; then
            key=$(echo "$line" | grep -oE '^[[:space:]]*(Mod|Super|Ctrl|Alt|Shift|XF86|Print)[A-Za-z0-9+_]*' | xargs)
            title="${BASH_REMATCH[2]}"
            [[ "$title" != "null" && -n "$key" ]] && printf "%-28s %s\n" "$key" "$title"
        # Match lines without hotkey-overlay-title but with action
        elif [[ "$line" =~ ^[[:space:]]*(Mod|Super|Ctrl|Alt|Shift|XF86|Print)[A-Za-z0-9+_]*[[:space:]]+(\{|\{[[:space:]]*$) ]]; then
            key=$(echo "$line" | grep -oE '^[[:space:]]*(Mod|Super|Ctrl|Alt|Shift|XF86|Print)[A-Za-z0-9+_]*' | xargs)
            # Extract action from braces
            action=$(echo "$line" | sed -n 's/.*{[[:space:]]*\([a-z-]*\).*/\1/p')
            [[ -n "$key" && -n "$action" ]] && printf "%-28s %s\n" "$key" "$action"
        fi
    done < "$BINDS_FILE" | sort -t' ' -k1,1
}

if [[ "$1" == "--print" || "$1" == "-p" ]]; then
    parse_bindings
else
    parse_bindings | fuzzel --dmenu -p "Keybindings" -w 70 -l 20
fi
